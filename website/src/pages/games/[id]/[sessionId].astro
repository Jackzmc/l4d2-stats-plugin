---
import Layout, { type PageInfo } from "@/layouts/Layout.astro";
let { id: gameId, sessionId } = Astro.params;
if(!gameId || !sessionId) return new Response(null, { status: 404 })

import { getSession, getSessionPlayers } from '../../../models/Game.ts'
import { Difficulty } from "@/types/game.ts";
import { getGamemode, replaceRoute, trimText, UNITS_TO_METERS } from "@/utils/index.ts";
import Level from "@/components/bulma/Level.astro";
import LevelItem from "@/components/bulma/LevelItem.astro";
import { formatHumanDuration } from "@/utils/date.ts";


const session = await getSession(sessionId)
if(!session) return Astro.rewrite(`/404?obj=session&id=${Astro.params.sessionId}`)
const otherSessions = await getSessionPlayers(gameId)

const mapName = session.map_name ?? session.map_id

const meta: PageInfo = {
	title: `${session.name}'s Session #${session.id} - ${mapName}`,
	description: `View statistics for ${session.name}'s game on ${mapName}`,
    hero: {
        title: mapName,
    },
}

export const prerender = false
---
<Layout meta={meta}>
    <section slot="hero" class="hero has-text-centered is-medium is-dark hero-map-bg" style={{'background-image': `linear-gradient(
      rgba(0, 0, 0, 0.5),
      rgba(0, 0, 0, 0.5)
    ), url("/img/maps/screenshots/${session.map_id}.jpeg"), url("/img/maps/default.png")`}}>
        <div class="hero-body">
            <!-- <Picture src={getMapPoster(session.map)} alt="map" /> -->
            <p class="title l4d2-text">#{session.id}</p>
            <p class="subtitle is-3"><b>{session.name}</b></p>
            <p class="subtitle is-3"><b>{mapName}</b></p>
        </div>
        <div class="hero-foot">
            <p class="subtitle mb-3">
                {getGamemode(session.gamemode)} • {Difficulty[session.difficulty]} • {Math.round(session.duration_game/60)} minutes long
            </p>
        </div>
    </section>
    <br>
    <div class="container">
        <div class="columns">
            <div class="column">
                <Level>
                    <LevelItem countup title="Zombie Kills" value={session.kills_common} />
                    <LevelItem countup title="Melee Kills" value={session.kills_melee} />
                    <LevelItem countup title="Bullets Fired" value={session.bullets_fired} />
                    {session.honks > 0 && <LevelItem countup title="Clowns Honked" value={session.honks} />}
                </Level>
                <div class="columns">
                    <div class="column is-6">
                        <div class="box has-background-link">
                              <Level>
                                <LevelItem class="has-text-white" title="Biles Thrown" value={session.used_bile} />
                                <LevelItem class="has-text-white" title="Pipes Thrown" value={session.used_pipebomb} />
                                <LevelItem class="has-text-white" title="Molotovs Thrown" value={session.used_molotov} />
                            </Level>
                        </div>
                        <div class="box has-background-success">
                            <Level>
                                <LevelItem class="has-text-white" title="Smoker Kills" value={session.kills_smoker} />
                                <LevelItem class="has-text-white" title="Boomer Kills" value={session.kills_boomer} />
                                <LevelItem class="has-text-white" title="Spitter Kills" value={session.kills_spitter} />
                            </Level>
                            <Level>
                                <LevelItem class="has-text-white" title="Jockey Kills" value={session.kills_jockey} />
                                <LevelItem class="has-text-white" title="Hunter Kills" value={session.kills_hunter} />
                                <LevelItem class="has-text-white" title="Charger Kills" value={session.kills_charger} />
                            </Level>
                            <Level>
                                <LevelItem class="has-text-white" title="Witches Kiled" value={session.kills_witch} />
                                <LevelItem class="has-text-white" title="Witches Crowned" value={session.witches_crowned} />
                                <LevelItem class="has-text-white" title="Tanks Killed" value={session.kills_tank} />
                            </Level>
                        </div>
                    </div>
                    <div class="column">
                        <div class="box has-background-warning">
                            <Level>
                                <LevelItem title="Kits (Self)" value={session.used_kit_self} />
                                <LevelItem title="Kits (Shared)" value={session.used_kit_other} />
                            </Level>
                            <Level>
                                <LevelItem title="Pills Consumed" value={session.used_pills} />
                                <LevelItem title="Adrenaline Consumed" value={session.used_adrenaline} />
                            </Level>
                        </div>
                        <div class="box has-background-danger">
                            <Level>
                                <LevelItem countup title="Deaths" value={session.deaths} />
                                <LevelItem countup title="Ledges Grabbed" value={session.times_hanging} />
                            </Level>
                            <Level>
                                <LevelItem countup title="Incaps" value={session.times_incapped} />
                                <LevelItem countup title="Fall Damage" value={session.damage_taken_fall} suffix=" HP" />
                            </Level>
                        </div>
                    </div>
                </div>
            </div>
            <div class="column is-3">
                <div class="box">
                    <h4 class="title is-4 mb-2">Players</h4>
                    <ul>
                        {otherSessions.map(player => (
                            <li>
                                <b>
                                    <a href={`/sessions/${player.steamid}/overview`}>
                                        {trimText(player.name, 23)}
                                    </a>
                                </b>
                                {player.sessionId != session.id && 
                                    <a href={replaceRoute(Astro, { sessionid: player.sessionId })} 
                                        class="is-pulled-right">(view stats)</a>
                                }
                                {player.sessionId === session.id && 
                                    <span class="is-pulled-right">(current)</span>
                                }
                            </li>
                        ))}
                    </ul>
                </div>
                <div class="box content">
                    <strong>Map Id</strong>
                    <p><a href={'/maps/' + session.map_id}>{session.map_id}</a></p>
                    <div class="columns">
                        <div class="column">
                            <strong>Gamemode</strong>
                            <p>{session.gamemode}</p>
                        </div>
                        <div class="column">
                            <strong>Difficulty</strong>
                            <p>{Difficulty[session.difficulty]}</p>
                        </div>
                    </div>
                    <strong>Most Used Weapon</strong>
                    <p>{session.top_weapon || "-"}</p>
                    <span class="tags">
                        {session.server_tags.map(tag => <span class="tag">{tag}</span>)}
                    </span>
                </div>
            </div>
        </div>
        <div class="columns">
            <div class="column">
                <h4 class="title is-4">Skills</h4>
                <div class="box has-background-info">
                    <Level>
                        <LevelItem countup title="Smokers Self-cleared" value={session.smokers_selfcleared} />
                        <LevelItem countup title="Hunters Deadstopped" value={session.hunters_deadstopped} />
                        <LevelItem countup title="Helped Pinned teammate" value={session.times_cleared_pinned} />
                        <LevelItem countup title="Rocks Hit By" value={session.rocks_hitby} />
                        <LevelItem countup title="Rocks Dodged" value={session.rocks_dodged} />
                    </Level>
                </div>
                <h4 class="title is-4">Damages</h4>
                <div class="box">
                    <Level>
                        <LevelItem countup title="Damage Dealt" value={session.damage_dealt} suffix=" HP" />
                        <LevelItem countup title="Damage Taken" value={session.damage_taken} suffix=" HP" />
                        <LevelItem countup title="To Tank" value={session.damage_dealt} suffix=" HP" />
                        <LevelItem countup title="To Witch" value={session.damage_taken} suffix=" HP" />
                    </Level>
                    <Level>
                        <LevelItem countup title="Friendly Fires" value={session.damage_dealt_friendly_count} />
                        <LevelItem countup title="Times Friendly Fired" value={session.damage_taken_friendly_count} />
                        <LevelItem countup title="Friendly Damage Dealt" value={session.damage_dealt_friendly} suffix=" HP" />
                        <LevelItem countup title="Friendly Damage Taken" value={session.damage_taken_friendly} suffix=" HP" />
                    </Level>
                </div>
                
                <h4 class="title is-4">Time</h4>
                <div class="box has-background-link-light">
                    <Level>
                        <LevelItem title="Total" value={formatHumanDuration(session.seconds_total)} />
                        <LevelItem title="Time Alive"value={formatHumanDuration(session.seconds_alive)}  />
                        <LevelItem title="Time Idle" value={formatHumanDuration(session.seconds_idle)} />
                        <LevelItem title="Time Dead"value={formatHumanDuration(session.seconds_dead)}  />
                    </Level>
                </div>

                <h4 class="title is-4">Other</h4>
                <div class="box has-background-warning">
                    <Level>
                        <LevelItem countup title="Times Boomed" value={session.times_boomed} />
                        <LevelItem countup title="Teammates Boomed" value={session.times_boomed_teammates} />
                        <LevelItem countup title="Car Alarms Activated" value={session.caralarms_activated} />
                        <LevelItem countup title="Shoves" value={session.times_shove} />
                        <LevelItem countup title="Jumps" value={session.times_jumped} />
                        <LevelItem countup title="Longest Distance Shot" value={session.longest_shot_distance*UNITS_TO_METERS} suffix=" meters" />
                    </Level>
                </div>
            </div>
        </div>
        <p>Campaign ID <a href={`/games/${session.game_uuid}`}>{session.game_uuid}</a></p>
        <p>Game ID <a href={`/games/${session.game_id}`}>{session.game_id}</a></p>
    </div>
</Layout>

<style>
img {
    width: 140px;
    height: 189px;
    display: inline;
    position: relative;
    left: 20px;
    top: 40px;
}
</style>