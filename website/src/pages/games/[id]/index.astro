---
import Layout, { type PageInfo } from "@/layouts/Layout.astro";
import PlayerBox from '@/components/misc/PlayerBox.astro'
let { id } = Astro.params;
if(!id) return new Response(null, { status: 404 })
id = id.substring(0, 8)

import { getGame, getSessions } from '../../../models/Game.ts'
import { Difficulty } from "@/types/game.ts";
import { formatUnixDate } from "@/utils/date.ts";
import { getGamemode } from "@/utils/index.ts";
import Level from "@/components/bulma/Level.astro";
import LevelItem from "@/components/bulma/LevelItem.astro";

const game = await getGame(id)
if(!game) return Astro.rewrite(`/404?obj=game&id=${Astro.params.id}`)
const sessions = await getSessions(id)


const mapName = game.map_name ?? game.map_id
const meta: PageInfo = {
	title: `${mapName} - Game ${id}`,
	description: "",
    hero: {
        title: mapName,
    },
}
const totalHonks = sessions.reduce((pv, cv) => pv + cv.honks, 0)
const honkMasterPlayer = totalHonks && sessions.reduce((pv, cv) => {
    return (cv.honks > pv.honks) ? cv : pv
}).steamid
const mvpPlayer = sessions.reduce((pv, cv) => {
    return (cv.kills_all_specials > pv.kills_all_specials) ? cv : pv
}).steamid

export const prerender = false
---
<Layout meta={meta}>
    <section slot="hero" class="hero has-text-centered is-dark hero-map-bg" style={{'background-image': `linear-gradient(
      rgba(0, 0, 0, 0.5),
      rgba(0, 0, 0, 0.5)
    ), url("/img/maps/screenshots/${game.map_id}.jpeg"), url("/img/maps/default.png")`}}>
        <div class="hero-body">
            <p class="title">{meta.hero!.title}</p>
            <p class="subtitle pt-2">
                Played {formatUnixDate(game.date)}
            </p>
        
        </div>
        <div class="hero-foot mb-3">
            <p class="subtitle pt-2">
                {getGamemode(game.gamemode)} • {Difficulty[game.difficulty]} • {Math.round(game.duration_game/60)} minutes long
            </p>
        </div>
    </section>

<section class="hero has-text-centered is-primary is-small has-text-white">
                <div class="hero-body">
                    <div class="container">
                        <Level>
                            <LevelItem class="has-text-white" title="Zombie Kills" value={game.commons_killed} />
                            <LevelItem class="has-text-white" title="Specials Killed" value={game.kills_all_specials} />
                            <LevelItem class="has-text-white" title="Damage Taken" value={game.damage_taken} />
                            {totalHonks > 0 && <LevelItem class="has-text-white" title="Total Honks" value={totalHonks} />}
                        </Level>
                    </div>
                </div>
            </section>
    <br>
    <section class="container pt-4 pb-5">
        <div class="fixed-grid has-2-cols-mobile has-5-cols ">
            <div class="grid">
                {sessions.map(sess =>{
                    const isMvp = sess.steamid == mvpPlayer
                    const isHonkMaster = sess.steamid == honkMasterPlayer
                    return <div class="cell" style="width: 260">
                        <PlayerBox showHonks={ totalHonks > 0 } player={sess} mvp={isMvp} honkMaster={isHonkMaster} />
                    </div>
                })}
            </div>
        </div>
    </section>

    <br>
    <div class="container">
        <div class="columns">
            <div class="column">
                <div class="box has-background-danger has-text-white">
                    <Level>
                        <LevelItem class="has-text-white" title="Incaps" value={game.times_incapped} />
                        <LevelItem class="has-text-white" title="Deaths" value={game.deaths} />
                        <LevelItem class="has-text-white" title="Kits Used" value={game.used_kit} />
                        <LevelItem class="has-text-white" title="Pills Used" value={game.used_pills} />
                        <LevelItem class="has-text-white" title="Adrenalines Used" value={game.used_adrenaline} />
                    </Level>
                </div>
                <div class="box has-background-link has-text-white">
                    <Level>
                        <LevelItem class="has-text-white" title="Biles Thrown" value={game.used_bile} />
                        <LevelItem class="has-text-white" title="Pipes Thrown" value={game.used_pipebomb} />
                        <LevelItem class="has-text-white" title="Molotovs Thrown" value={game.used_molotov} />
                    </Level>
                </div>
            </div>
            <div class="column is-2">
                <div class="box content">
                    <h4>Map Id</h4>
                    <p>{game.map_id}</p>
                    <h4>Server Tags</h4>
                    <span class="tags">
                        {game.server_tags.map(tag => <span class="tag">{tag}</span>)}
                    </span>
                </div>
            </div>
        </div>
        <div class="block">
            <p>Campaign ID <a href={`/games/${game.uuid}`}>{game.uuid}</a></p>
            <p>Game ID <a href={`/games/${game.id}`}>{game.id}</a></p>
        </div>
    </div>

</Layout>

<style>
.hero-map-bg {
    background-position: center;
    background-blend-mode:
    /* color: black; */
}
.hero-map-bg p {
    /* color: black; */
    text-shadow: 4px black;
}
</style>