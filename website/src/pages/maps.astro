---
import Layout, { type PageInfo } from "../layouts/Layout.astro";
import { Icon } from 'astro-icon/components'
const meta: PageInfo = {
	title: "Campaigns",
	description: "View stats about total number of games, minutes played and ratings for all maps"
}

import { getMapPoster } from '../utils/index.ts'
import { getMapPlayCount, getMapRatings } from "../models/Map.ts";
import { Picture } from "astro:assets";

const topMaps = await getMapPlayCount(false, 3)
const mapRatings = await getMapRatings()

export const prerender = true
Astro.response.headers.set('Cache-Control', 'public, max-age=3600');
---

<Layout meta={meta}>
	<div class="container">
        <p class="title is-6">Top Maps</p>
        <nav class="level">
            {topMaps.map((map, i) => {
                return <div class="level-item has-text-centered">
                    <div class="topmap">
                        <h3 class="title is-3 mb-2 l4d2-text">
                            #{i+1}
                        </h3>
                        <figure class="image">
                            <Picture width={200} height={300} src={getMapPoster(map.map)} alt={`Poster for ${map.name}`}/>
                        </figure>
                        <p class="title is-4 l4d2-text">{map.name}</p>
                        <div class="subtitle is-6">{map.count.toLocaleString()} games played</div>
                    </div>
                </div>
            })}
        </nav>
        
        <hr>

        <p class="title is-6">Map Ratings</p>
        <table class="table is-fullwidth is-striped">
            <thead>
                <tr>
                    <th>Map</th>
                    <th>Games Played</th>
                    <th>Average Duration</th>
                    <th>Rating</th>
                    <th># of Ratings</th>
                </tr>
            </thead>
            <tbody>
                {mapRatings.map(row => (
                    <tr>
                        <td><b title={row.map} class="py-2"><a href={`/maps/${row.map}`}>{row.name}</a></b></td>
                        <td>{row.gamesPlayed.toLocaleString()}</td>
                        <td>{row.avgMinutesPlayed.toLocaleString(undefined, { maximumFractionDigits: 0 })} minutes</td>
                        <td>
                            {Array(5).fill(undefined).map((_,i) => 
                                <Icon name={Math.floor(row.avgRating) > i ? "weui:star-filled" : "weui:star-outlined"} />
                            )}
                            {row.avgRating.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 })}
                        </td>
                        <td>{row.ratings}</td>
                    </tr>
                ))}
            </tbody>
        </table>
	</div>
</Layout>

<style>
.level-item {
    /* border: 2px solid royalblue; */
    border-radius: 8px;
    padding: 15px;
}
.level-item > div {
    padding: 20px;
    border: 2px solid black;
    box-shadow: 0.2em 0.2em;
}
.level-item figure {
    height: 300px;
}
</style>